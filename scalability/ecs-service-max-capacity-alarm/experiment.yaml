title: When ECS service reaches maximum container count, operations should be notified
description: |-
  todo

contributions:
  security: "low"
  reliability: "medium"
  scalability: "high"

configuration:
  stress_duration: "10m"
  stress_users: "10"
  script_file: "../../load-generation/comments-k6/journey_prod.js"
  cluster_name: "live-comments-full-cluster"
  service_name: "comments-api-service"
  tf__cluster_name: "live-comments-full-cluster"
  tf__service_name: "comments-api-service"
  application_url:
    type: probe
    provider:
      type: python
      module: devlearnops.aws.ssm.probes
      func: get_parameter
      arguments:
        name: "/app/comments/live/web_url"

controls:
  - name: "configure-alarm-with-terraform"
    provider:
      type: python
      module: chaosterraform.control
      arguments:
        silent: false
        retain: true

steady-state-hypothesis:
  title: "Verify web server is available"
  probes:
    - type: probe
      name: "site-responsive"
      tolerance: true
      provider:
        func: http
        module: chaosgrafana.k6.probes
        type: python
        arguments:
          endpoint: ${application_url}/users
          method: GET
          timeout: 5
          duration: 10s
          vus: 2
    - type: probe
      name: "wait-for-max-container-notification"
      tolerance:
        type: regex
        pattern: "ALARM"
        target: "NewStateValue"
      provider:
        type: python
        module: devlearnops.aws.sqs.probes
        func: wait_for_alarm_notification
        arguments:
          queue_url: ${tf_out__queue_url}
          topic_arn: ${tf_out__topic_arn}
          alarm_name: ${tf_out__alarm_name}
          timeout: 180
          consume_message: true
method:
  #- type: action
    #name: "apply-test-load"
    #provider:
      #func: run_script
      #module: chaosgrafana.k6.actions
      #type: python
      #arguments:
        #script_path: ${script_file}
        #vus: ${stress_users}
        #duration: ${stress_duration}
        #environ:
          #COMMENTS_URL: "${application_url}"
  - type: action
    name: set-desired-to-max
    provider:
      type: python
      module: chaosaws.ecs.actions
      func: update_desired_count
      arguments:
        cluster: ${cluster_name}
        service: ${service_name}
        desired_count: 3
