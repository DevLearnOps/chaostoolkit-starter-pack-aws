title: When the traffic increases, the containers should scale out
description: |-
  This is an experiment where we test the autoscaling policy based on the rps.
  We are going to generate load using k6

configuration:
  stress_duration: "10m"
  stress_users: "10"
  script_file: "../../../load_testing/script.js"
  cluster_name: "live-comments-full-cluster"
  service_name: "comments-api-service"
  application_url:
    type: probe
    provider:
      type: python
      module: devlearnops.aws.ssm.probes
      func: get_parameter
      arguments:
        name: "/app/comments/live/web_url"

steady-state-hypothesis:
  title: "Verify web server is available"
  probes:
    - type: probe
      name: "site-responsive"
      tolerance: 200
      provider:
        type: http
        url: "${application_url}/users"
        method: "GET"
        timeout: 5
    - name: "desired-equals-running"
      type: probe
      tolerance: true
      provider:
        type: python
        module: chaosaws.ecs.probes
        func: are_all_desired_tasks_running
        arguments:
          cluster: ${cluster_name}
          service: ${service_name}
    - name: "desired-containers-should-be-max"
      type: probe
      tolerance:
        type: jsonpath
        path: '$["services"][0]["desiredCount"]'
        expect: 3
      provider:
        type: python
        module: chaosaws.ecs.probes
        func: describe_service
        arguments:
          cluster: ${cluster_name}
          service: ${service_name}

method:
  - type: action
    name: "set-env"
    provider:
      type: python
      module: devlearnops.os.actions
      func: set_env
      arguments:
        environ:
          COMMENTS_URL: "${application_url}"

  - type: action
    name: "apply-test-load"
    provider:
      func: run_script
      module: chaosk6.actions
      type: python
      arguments:
        script_path: ${script_file}
        vus: ${stress_users}
        duration: ${stress_duration}
