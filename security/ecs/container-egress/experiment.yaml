title: "Exfiltration test with ECS service security groups"
description: |
  Verify application security configuration.
  Deploy a new probe in an ECS cluster assigning the same security group as
  as the service under test. The probe service will attempt to reach some
  forbidden urls to verify the security group rules are effective, and not
  just passing a static analysis.

contributions:
  security: "high"
  reliability: "low"
  scalability: "low"

configuration:
  forbidden_endpoint: "https://www.google.com"
  tf__target_service_secgroup: sg-0ad97dde3d3ef64e2
  tf_conf__retain: true

controls:
  - name: terraform
    provider:
      type: python
      module: chaostf.control

method:
  - type: action
    name: "wait_service_stable"
    provider:
      type: python
      module: chaosaws_extended.ecs.actions
      func: wait_for_service_stable
      arguments:
        cluster: ${tf_out__chaosprobe_cluster}
        service: ${tf_out__chaosprobe_service}
        timeout_minutes: 10
    pauses:
      after: 10

steady-state-hypothesis:
  title: "Forbidden urls are blocked"
  probes:
    - type: probe
      name: "all-requests-attempted-should-fail"
      tolerance:
        type: jsonpath
        path: "$.body.error_count"
        expect: 3
      provider:
        type: http
        url: "${tf_out__dns_name}/http/egress"
        method: "POST"
        headers:
          Content-Type: "application/json"
        arguments:
          url: "https://www.google.com"
          repeat: 3
          timeout: 1
